import { defaultLocale, locales, type Locale } from "./i18n/config";

export const onRequest = (
  {
    url,
    redirect,
  }: {
    url: URL;
    redirect: (
      to: string,
      code: number,
      options?: Record<string, string>
    ) => void;
  },
  next: () => void
) => {
  const pathname = url.pathname;

  // Extract the potential locale from the path
  const segments = pathname.split("/").filter(Boolean); // Remove empty strings
  const maybeLocale = segments[0];

  // If we already have a valid locale in the URL, continue
  if (maybeLocale && locales.includes(maybeLocale as Locale)) {
    return next();
  }

  // If we're on the root path or have no locale, redirect to default locale
  if (
    pathname === "/" ||
    !maybeLocale ||
    !locales.includes(maybeLocale as Locale)
  ) {
    // Always redirect to the default locale for static builds
    const to = `/${defaultLocale}${pathname === "/" ? "" : pathname}`;
    return redirect(to, 302);
  }

  return next();
};
